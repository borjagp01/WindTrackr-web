================================================================================
  FIREBASE FUNCTIONS PARA PRON√ìSTICOS AEMET - RESUMEN COMPLETO
================================================================================

üì¶ ARCHIVOS CREADOS
================================================================================

functions/
  ‚îú‚îÄ‚îÄ package.json                    - Dependencias y scripts
  ‚îú‚îÄ‚îÄ index.js                        - C√≥digo principal (updateForecasts + updateForecastManual)
  ‚îú‚îÄ‚îÄ .gitignore                      - Ignorar node_modules y .env
  ‚îú‚îÄ‚îÄ .env.example                    - Template variables de entorno
  ‚îú‚îÄ‚îÄ README.md                       - Documentaci√≥n t√©cnica completa
  ‚îú‚îÄ‚îÄ QUICKSTART.md                   - Gu√≠a r√°pida de despliegue (5 pasos)
  ‚îú‚îÄ‚îÄ STATION_CONFIG_EXAMPLE.md       - Ejemplos de configuraci√≥n
  ‚îú‚îÄ‚îÄ IMPLEMENTATION_SUMMARY.md       - Resumen detallado de implementaci√≥n
  ‚îú‚îÄ‚îÄ add-aemet-config.js            - Helper script documentaci√≥n
  ‚îî‚îÄ‚îÄ setup-stations.js               - Script interactivo de configuraci√≥n

Actualizados:
  - firebase.json                     - A√±adida configuraci√≥n functions
  - README.md                         - Actualizado roadmap y documentaci√≥n

================================================================================
  üéØ FUNCIONALIDADES IMPLEMENTADAS
================================================================================

1. CLOUD FUNCTION SCHEDULED: updateForecasts
   - Se ejecuta cada 6 horas (00:00, 06:00, 12:00, 18:00 Madrid)
   - Lee todas las estaciones de Firebase
   - Para cada estaci√≥n con ine_code + aemet_api_key:
     * Hace petici√≥n a AEMET (2 pasos: metadata ‚Üí datos)
     * Transforma datos al formato de la app
     * Guarda en weather_stations/{id}/forecast
   - Espera 61s entre peticiones (l√≠mite AEMET: 1/min)
   - Logging completo de resultados

2. HTTP ENDPOINT: updateForecastManual
   - POST request para actualizaci√≥n manual
   - Opciones:
     * Sin body: actualiza todas las estaciones
     * Con {"stationId": "id"}: actualiza solo una
   - √ötil para testing y actualizaciones on-demand

3. TRANSFORMACI√ìN DE DATOS
   - Input: Datos AEMET (predicci√≥n horaria municipal)
   - Output: Formato app (compatible con tipo Forecast)
   - Conversiones:
     * Velocidad: km/h ‚Üí nudos (knots)
     * Direcci√≥n: texto ("N", "NE") ‚Üí grados (0-360)
     * Timestamps: formato AEMET ‚Üí ISO 8601
   - Filtrado: solo pr√≥ximas 72 horas

4. MANEJO DE L√çMITES
   - AEMET: 1 petici√≥n/minuto por API key
   - Soluci√≥n: procesamiento secuencial con espera 61s
   - Soporte: API keys diferentes por estaci√≥n (paralelizaci√≥n futura)

================================================================================
  üìã CONFIGURACI√ìN REQUERIDA
================================================================================

CADA ESTACI√ìN NECESITA EN FIREBASE:

{
  "weather_stations": {
    "tu-estacion-id": {
      "info": {
        "ine_code": "11033",           ‚Üê C√≥digo INE del municipio
        "aemet_api_key": "eyJhbGc..."  ‚Üê API Key de AEMET
      }
    }
  }
}

D√ìNDE OBTENER:

1. C√≥digo INE
   - Web: https://www.ine.es/daco/daco42/codmun/codmunmapa.htm
   - Ejemplos:
     * Tarifa: 11033
     * Algeciras: 11004
     * Barbate: 11007

2. API Key AEMET
   - Registro: https://opendata.aemet.es/centrodedescargas/inicio
   - Proceso: Registro ‚Üí Perfil ‚Üí Solicitar API Key
   - L√≠mite: 1 petici√≥n/minuto por key
   - Recomendaci√≥n: Una key diferente por estaci√≥n

================================================================================
  üöÄ PASOS PARA DESPLEGAR
================================================================================

1. INSTALAR DEPENDENCIAS
   cd functions
   npm install

2. CONFIGURAR ESTACIONES
   Opci√≥n A (Firebase Console):
     - Ir a Realtime Database
     - Navegar a weather_stations/{id}
     - A√±adir nodo "info" con ine_code y aemet_api_key

   Opci√≥n B (Script):
     cd functions
     node setup-stations.js
     # Sigue las instrucciones interactivas

3. DESPLEGAR FUNCTIONS
   firebase deploy --only functions

4. VERIFICAR
   # Ver logs
   firebase functions:log --only updateForecasts

   # Probar manualmente
   curl -X POST https://REGION-PROJECT.cloudfunctions.net/updateForecastManual \
     -H "Content-Type: application/json" \
     -d '{"stationId": "tu-estacion"}'

5. ‚úÖ LISTO
   - La funci√≥n se ejecutar√° autom√°ticamente cada 6 horas
   - Los pron√≥sticos se guardar√°n en forecast/
   - Tu app puede leerlos en tiempo real

================================================================================
  üìä ESTRUCTURA DE DATOS GENERADA
================================================================================

ANTES (solo tu configuraci√≥n):
{
  "weather_stations": {
    "mi-estacion": {
      "name": "...",
      "location": {...},
      "info": {
        "ine_code": "11033",
        "aemet_api_key": "..."
      },
      "current": {...},
      "history": {...}
    }
  }
}

DESPU√âS (con pron√≥stico autom√°tico):
{
  "weather_stations": {
    "mi-estacion": {
      "name": "...",
      "location": {...},
      "info": {
        "ine_code": "11033",
        "aemet_api_key": "..."
      },
      "forecast": {                      ‚Üê NUEVO NODO CREADO
        "data": {
          "hourly": [
            {
              "timestamp": "2025-11-20T12:00:00",
              "windKts": 15,
              "gustKts": 22,
              "directionDeg": 270,
              "tempC": 18
            },
            {
              "timestamp": "2025-11-20T13:00:00",
              "windKts": 18,
              "gustKts": 25,
              "directionDeg": 280,
              "tempC": 19
            },
            ... (hasta 72 horas)
          ]
        },
        "lastUpdate": 1700485200000,
        "source": "AEMET"
      },
      "current": {...},
      "history": {...}
    }
  }
}

================================================================================
  üîç TROUBLESHOOTING
================================================================================

PROBLEMA: "Station missing ine_code or aemet_api_key"
SOLUCI√ìN: Verifica que el nodo info existe con ambos campos

PROBLEMA: "AEMET request failed: 401"
SOLUCI√ìN: API key inv√°lida o expirada. Solicita nueva en AEMET

PROBLEMA: "AEMET request failed: 429"
SOLUCI√ìN: Demasiadas peticiones. Espera 1 minuto o usa API keys separadas

PROBLEMA: "No forecast data returned"
SOLUCI√ìN: C√≥digo INE incorrecto o municipio sin datos

PROBLEMA: No se actualiza autom√°ticamente
SOLUCI√ìN:
  1. Verifica que la function est√° desplegada: firebase functions:list
  2. Revisa logs: firebase functions:log --only updateForecasts
  3. Espera la pr√≥xima ejecuci√≥n (cada 6h)

================================================================================
  üìà MONITOREO Y LOGS
================================================================================

VER LOGS EN TIEMPO REAL:
  firebase functions:log

VER LOGS DE FUNCI√ìN ESPEC√çFICA:
  firebase functions:log --only updateForecasts

VER LOGS RECIENTES (√∫ltimos 30 min):
  firebase functions:log --since 30m

LOGS EXITOSOS MOSTRAR√ÅN:
  ‚úÖ Found N stations to process
  ‚úÖ Successfully updated forecast for station X
  ‚è≥ Waiting 61 seconds before next AEMET request...
  ‚úÖ Forecast update job completed
     Success: N
     Failed: 0
     Skipped: 0

================================================================================
  üéØ VENTAJAS DE ESTA IMPLEMENTACI√ìN
================================================================================

‚úÖ AUTOMATIZACI√ìN COMPLETA
   - Cron cada 6 horas sin intervenci√≥n manual
   - Datos siempre actualizados

‚úÖ ESCALABLE
   - Soporta N estaciones
   - API keys independientes
   - Procesamiento inteligente

‚úÖ RESILIENTE
   - Contin√∫a si una estaci√≥n falla
   - Logging detallado
   - Skips autom√°ticos

‚úÖ MANTENIBLE
   - C√≥digo modular
   - Documentaci√≥n completa
   - F√°cil de extender

‚úÖ INTEGRADO
   - Compatible con formato existente
   - Sin cambios en la app
   - Lectura en tiempo real

================================================================================
  üìö DOCUMENTACI√ìN DISPONIBLE
================================================================================

functions/README.md
  - Documentaci√≥n t√©cnica completa
  - Descripci√≥n de functions
  - API de AEMET explicada
  - Instalaci√≥n y deploy
  - Troubleshooting extenso

functions/QUICKSTART.md
  - Gu√≠a de 5 pasos para desplegar
  - Configuraci√≥n avanzada
  - Ejemplos de uso

functions/STATION_CONFIG_EXAMPLE.md
  - Estructura completa de estaci√≥n
  - Tabla de c√≥digos INE
  - Proceso de obtenci√≥n API keys
  - Configuraci√≥n manual y autom√°tica

functions/IMPLEMENTATION_SUMMARY.md
  - Resumen ejecutivo
  - Arquitectura de datos
  - Flujo de ejecuci√≥n
  - Referencias

================================================================================
  üîú MEJORAS FUTURAS (OPCIONALES)
================================================================================

PR√ìXIMAS IMPLEMENTACIONES:
  - Retry autom√°tico en errores temporales
  - Cache Redis para evitar peticiones duplicadas
  - Webhooks para notificar cambios
  - Dashboard analytics pron√≥sticos vs realidad
  - Predicci√≥n ML basada en hist√≥ricos
  - Integraci√≥n con m√°s fuentes (OpenWeatherMap)

================================================================================
  üìû SOPORTE Y REFERENCIAS
================================================================================

DOCUMENTACI√ìN AEMET:
  https://opendata.aemet.es/dist/index.html

FIREBASE FUNCTIONS:
  https://firebase.google.com/docs/functions

C√ìDIGOS INE:
  https://www.ine.es/daco/daco42/codmun/codmunmapa.htm

ISSUES Y SOPORTE:
  GitHub Issues del proyecto

================================================================================
  ‚úÖ CHECKLIST DE IMPLEMENTACI√ìN
================================================================================

[ ] 1. Instalar dependencias: cd functions && npm install
[ ] 2. Obtener c√≥digos INE de tus municipios
[ ] 3. Registrarse en AEMET y obtener API keys
[ ] 4. Configurar estaciones en Firebase (info/ine_code + aemet_api_key)
[ ] 5. Desplegar functions: firebase deploy --only functions
[ ] 6. Probar manualmente: curl POST /updateForecastManual
[ ] 7. Verificar logs: firebase functions:log
[ ] 8. Confirmar datos en Firebase Console: forecast/
[ ] 9. Verificar en app que se leen los pron√≥sticos
[ ] 10. Esperar ejecuci√≥n autom√°tica (pr√≥ximas 6h)

================================================================================

Versi√≥n: 0.3.1-functions
Fecha: Noviembre 2025
Estado: ‚úÖ Production Ready

================================================================================
